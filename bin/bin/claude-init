#!/bin/bash
set -e
set -u
set -o pipefail

# Configuration
DOTFILES_CLAUDE="${HOME}/dotfiles/claude/.claude"
TEMPLATE_DIR="${HOME}/dotfiles/bin/bin/templates"

# Default options
FORCE=false
ALL=false
UPDATE=false
MINIMAL=false
NO_CLAUDE_MD=false
AGENTS_ONLY=false
COMMANDS_ONLY=false
TARGET_DIR="."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

show_help() {
    cat << 'EOF'
claude-init - Initialize Claude Code configuration for a project

USAGE:
    claude-init [OPTIONS] [TARGET_DIR]

OPTIONS:
    -h, --help          Show this help message
    -f, --force         Overwrite existing .claude directory
    -a, --all           Copy all configs (non-interactive)
    -u, --update        Update/refresh configs from dotfiles
    -m, --minimal       Only create directory structure + CLAUDE.md
    --no-claude-md      Skip CLAUDE.md creation
    --agents-only       Only copy agents
    --commands-only     Only copy commands

ARGUMENTS:
    TARGET_DIR          Target directory (default: current directory)

EXAMPLES:
    # Initialize current directory with all configs
    claude-init --all

    # Initialize specific directory
    claude-init --all ~/projects/my-app

    # Update existing configs from dotfiles
    claude-init --update

    # Only create structure and CLAUDE.md
    claude-init --minimal

NOTES:
    - Source configs are read from: ~/dotfiles/claude/.claude/
    - Creates .claude/{agents,commands,hooks}/ directories
    - Adds .claude/settings.local.json to .gitignore
EOF
    exit 0
}


log_info() {
    echo -e "${BLUE}$1${NC}"
}

log_success() {
    echo -e "${GREEN}$1${NC}"
}

log_warning() {
    echo -e "${YELLOW}$1${NC}"
}

log_error() {
    echo -e "${RED}$1${NC}"
}

ensure_gitignore_entry() {
    local target_dir="$1"
    local entry="$2"
    local gitignore_path="${target_dir}/.gitignore"

    if [[ -f "${gitignore_path}" ]]; then
        if grep -qxF "$entry" "${gitignore_path}"; then
            return 0 # Already exists
        fi
    fi

    # Add entry with section comment
    {
        echo ""
        echo "# Claude Code local settings"
        echo "$entry"
    } >> "${gitignore_path}"

    log_info "   Added $entry to .gitignore"
}

copy_directory() {
    local src="$1"
    local dest="$2"
    local name="$3"

    if [[ ! -d "$src" ]]; then
        log_warning "   Source directory not found $src"
        return 1
    fi

    mkdir -p "$dest"

    local count=0
    for file in "$src"/*; do
        if [[ -f "$file" ]]; then
            cp "$file" "$dest/"
            ((count++))
        elif [[ -d "$file" ]]; then
            cp -r "$file" "$dest/"
            ((count++))
        fi
    done

    log_success "   Copied $count $name to $dest"
    return 0
}

copy_with_update() {
    local src="$1"
    local dest="$2"
    local name="$3"

    if [[ ! -d "$src" ]]; then
        log_warning "   Source directory not found: $src"
        return 1
    fi

    mkdir -p "$dest"

    local copied=0
    local skipped=0
    local updated=0

    for file in "$src"/*; do
        if [[ -f "$file" ]]; then
            local filename
            filename=$(basename "$file")
            local dest_file="${dest}/${filename}"

            if [[ ! -f "$dest_file" ]]; then
                cp "$file" "$dest_file"
                ((copied++))
            elif cmp -s "$file" "$dest_file"; then
                ((skipped++))
            else
                if [[ "$FORCE" == true ]]; then
                    cp "$file" "$dest_file"
                    ((updated++))
                else
                    log_warning "   Skipped (differs): $filename (use --force to overwrite)"
                fi
            fi
        elif [[ -d "$file" ]]; then
            local subdir_name
            subdir_name=$(basename "$file")
            copy_with_update "$file" "${dest}/${subdir_name}" "$subdir_name"
        fi
    done

    log_info "   $name: $copied new, $updated updated, $skipped unchanged"
    return 0
}

generate_claude_md() {
    local target_dir="$1"
    local template_file="${TEMPLATE_DIR}/CLAUDE.md.template"
    local output_file="${target_dir}/CLAUDE.md"

    if [[ ! -f "$template_file" ]]; then
        log_error "   Template not found: $template_file"
        return 1
    fi

    if [[ -f "$output_file" ]] && [[ "$FORCE" != true ]]; then
        log_warning "   CLAUDE.md already exists (use --force to overwrite)"
        return 0
    fi

    cp "$template_file" "$output_file"
    log_success "   Created CLAUDE.md"
}

validate_source() {
    if [[ ! -d "$DOTFILES_CLAUDE" ]]; then
        log_error "Source directory not found: $DOTFILES_CLAUDE"
        log_error "Make sure your dotfiles are set up correctly."
        exit 1
    fi
}

check_existing() {
    local target_dir="$1"
    local claude_dir="${target_dir}/.claude"

    if [[ -d "$claude_dir" ]]; then
        if [[ "$FORCE" != true ]] && [[ "$UPDATE" != true ]]; then
            log_error ".claude directory already exists at: $claude_dir"
            log_error "Use --force to overwrite or --update to sync"
            exit 1
        fi
    fi
}

main() {
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                ;;
            -f|--force)
                FORCE=true
                shift
                ;;
            -a|--all)
                ALL=true
                shift
                ;;
            -u|--update)
                UPDATE=true
                shift
                ;;
            -m|--minimal)
                MINIMAL=true
                shift
                ;;
            --no-claude-md)
                NO_CLAUDE_MD=true
                shift
                ;;
            --agents-only)
                AGENTS_ONLY=true
                shift
                ;;
            --commands-only)
                COMMANDS_ONLY=true
                shift
                ;;
            -*)
                log_error "Unknown option: $1"
                show_help
                ;;
            *)
                TARGET_DIR="$1"
                shift
                ;;
        esac
    done

    # Resolve target directory
    TARGET_DIR=$(cd "$TARGET_DIR" && pwd)
    local claude_dir="${TARGET_DIR}/.claude"

    echo ""
    log_info "Initializing Claude Code configuration"
    log_info "Target: $TARGET_DIR"
    echo ""

    # Validate
    validate_source
    check_existing "$TARGET_DIR"

    # Handle update mode
    if [[ "$UPDATE" == true ]]; then
        if [[ ! -d "$claude_dir" ]]; then
            log_error ".claude directory doesn't exist. Use --all to create it."
            exit 1
        fi

        log_info "Updating from dotfiles..."

        if [[ "$COMMANDS_ONLY" != true ]]; then
            copy_with_update "${DOTFILES_CLAUDE}/agents" "${claude_dir}/agents" "agents"
        fi
        if [[ "$AGENTS_ONLY" != true ]]; then
            copy_with_update "${DOTFILES_CLAUDE}/commands" "${claude_dir}/commands" "commands"
        fi

        log_success "Update complete!"
        exit 0
    fi

    # Create directory structure
    log_info "Creating directory structure..."
    mkdir -p "${claude_dir}/agents"
    mkdir -p "${claude_dir}/commands"
    mkdir -p "${claude_dir}/hooks"
    mkdir -p "${claude_dir}/thoughts/shared/plans"
    mkdir -p "${claude_dir}/thoughts/shared/research"
    mkdir -p "${claude_dir}/thoughts/shared/decisions"
    mkdir -p "${claude_dir}/thoughts/local/scratch"
    log_success "   Created .claude/{agents,commands,hooks,thoughts}/"

    # Handle minimal mode
    if [[ "$MINIMAL" == true ]]; then
        if [[ "$NO_CLAUDE_MD" != true ]]; then
            log_info "Creating CLAUDE.md..."
            generate_claude_md "$TARGET_DIR"
        fi
        ensure_gitignore_entry "$TARGET_DIR" ".claude/settings.local.json"
        ensure_gitignore_entry "$TARGET_DIR" ".claude/thoughts/local/"
        echo ""
        log_success "Minimal initialization complete!"
        exit 0
    fi

    # Copy configs (non-interactive --all mode)
    if [[ "$ALL" == true ]]; then
        log_info "Copying configurations..."

        if [[ "$COMMANDS_ONLY" != true ]]; then
            copy_directory "${DOTFILES_CLAUDE}/agents" "${claude_dir}/agents" "agents"
        fi

        if [[ "$AGENTS_ONLY" != true ]]; then
            copy_directory "${DOTFILES_CLAUDE}/commands" "${claude_dir}/commands" "commands"
        fi

        # Copy hooks if they exist
        if [[ -d "${DOTFILES_CLAUDE}/hooks" ]]; then
            copy_directory "${DOTFILES_CLAUDE}/hooks" "${claude_dir}/hooks" "hooks"
        fi

        # Generate CLAUDE.md
        if [[ "$NO_CLAUDE_MD" != true ]]; then
            log_info "Creating CLAUDE.md..."
            generate_claude_md "$TARGET_DIR"
        fi

        # Update gitignore
        ensure_gitignore_entry "$TARGET_DIR" ".claude/settings.local.json"
        ensure_gitignore_entry "$TARGET_DIR" ".claude/thoughts/local/"

        echo ""
        log_success "Initialization complete!"
        echo ""
        echo "Next steps:"
        echo "  1. Edit CLAUDE.md to add project-specific info"
        echo "  2. Customize agents/commands as needed"
        echo "  3. Run Claude Code in your project"
        exit 0
    fi

    # Interactive mode
    log_info "Select what to copy:"
    echo ""

    # Agents selection
    echo -n "Copy agents? [Y/n] "
    read -r copy_agents
    copy_agents=${copy_agents:-Y}

    # Commands selection
    echo -n "Copy commands? [Y/n] "
    read -r copy_commands
    copy_commands=${copy_commands:-Y}

    # Hooks selection
    echo -n "Copy hooks? [Y/n] "
    read -r copy_hooks
    copy_hooks=${copy_hooks:-Y}

    # CLAUDE.md selection
    echo -n "Create CLAUDE.md? [Y/n] "
    read -r create_claude_md
    create_claude_md=${create_claude_md:-Y}

    echo ""
    log_info "Copying configurations..."

    if [[ "$copy_agents" =~ ^[Yy]$ ]]; then
        copy_directory "${DOTFILES_CLAUDE}/agents" "${claude_dir}/agents" "agents"
    fi

    if [[ "$copy_commands" =~ ^[Yy]$ ]]; then
        copy_directory "${DOTFILES_CLAUDE}/commands" "${claude_dir}/commands" "commands"
    fi

    if [[ "$copy_hooks" =~ ^[Yy]$ ]] && [[ -d "${DOTFILES_CLAUDE}/hooks" ]]; then
        copy_directory "${DOTFILES_CLAUDE}/hooks" "${claude_dir}/hooks" "hooks"
    fi

    if [[ "$create_claude_md" =~ ^[Yy]$ ]]; then
        log_info "Creating CLAUDE.md..."
        generate_claude_md "$TARGET_DIR"
    fi

    # Update gitignore
    ensure_gitignore_entry "$TARGET_DIR" ".claude/settings.local.json"
    ensure_gitignore_entry "$TARGET_DIR" ".claude/thoughts/local/"

    echo ""
    log_success "Initialization complete!"
    echo ""
    echo "Next steps:"
    echo "  1. Edit CLAUDE.md to add project-specific info"
    echo "  2. Customize agents/commands as needed"
    echo "  3. Run Claude Code in your project"
}

main "$@"
