#!/bin/bash

# create_worktree.sh - Create a new worktree for development work
# Usage: ./create_worktree.sh [worktree_name] [base_branch]
# If no name provided, generates a unique human-readable one
# If no base branch provided, uses current branch

set -e  # Exit on any error


# Function to display help
show_help() {
    cat << 'EOF'
create_worktree - Create a new git worktree for development work

USAGE:
    ./create_worktree [OPTIONS]

OPTIONS:
    --help, -h           Display this help message
    --name, -n <name>    Name for the new worktree
    --base, -b <branch>  Base branch to create worktree from

EXAMPLES:
    # Create a worktree with auto-generated name from current branch
    ./create_worktree

    # Create a worktree named 'feature-x' from 'main' branch
    ./create_worktree --name feature-x --base main

    # Short form with named arguments
    ./create_worktree -n feature-x -b develop

    # Create with auto-generated name from specific branch
    ./create_worktree --base main

NOTES:
    - Worktree directories are created in: ~/wt/<repo_name>/
    - The ~/wt/<repo_name>/ directory must exist before running this script
    - A .claude directory will be copied from the main worktree if it exists
    - To remove a worktree later, run:
        git worktree remove <worktree_path>
        git branch -D <branch_name>
EOF
    exit 0
}

# Function to generate a unique worktree name
generate_unique_name() {
    local adjectives=("swift" "bright" "clever" "smooth" "quick" "clean" "sharp" "neat" "cool" "fast")
    local nouns=("fix" "task" "work" "dev" "patch" "branch" "code" "build" "test" "run")

    local adj=${adjectives[$RANDOM % ${#adjectives[@]}]}
    local noun=${nouns[$RANDOM % ${#nouns[@]}]}
    local timestamp=$(date +%H%M)

    echo "${adj}_${noun}_${timestamp}"
}

# Parse arguments
WORKTREE_NAME=""
BASE_BRANCH=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --help|-h)
            show_help
            ;;
        --name|-n)
            WORKTREE_NAME="$2"
            shift 2
            ;;
        --base|-b)
            BASE_BRANCH="$2"
            shift 2
            ;;
        *)
            echo "Error: Unknown option '$1'"
            show_help
            ;;
    esac
done

# Set defaults if not provided
WORKTREE_NAME=${WORKTREE_NAME:-$(generate_unique_name)}
BASE_BRANCH=${BASE_BRANCH:-$(git branch --show-current)}

# Get base directory name
REPO_BASE_NAME=$(basename "$(pwd)")

WORKTREE_DIR_NAME="${WORKTREE_NAME}"
WORKTREES_BASE="$HOME/wt/${REPO_BASE_NAME}"

WORKTREE_PATH="${WORKTREES_BASE}/${WORKTREE_DIR_NAME}"

echo "üå≥ Creating worktree: ${WORKTREE_NAME}"
echo "üìÅ Location: ${WORKTREE_PATH}"

# Check if worktrees base directory exists
if [ ! -d "$WORKTREES_BASE" ]; then
    echo "‚ùå Error: Directory $WORKTREES_BASE does not exist."
    echo "   Please create it first: mkdir -p $WORKTREES_BASE"
    exit 1
fi

# Check if worktree already exists
if [ -d "$WORKTREE_PATH" ]; then
    echo "‚ùå Error: Worktree directory already exists: $WORKTREE_PATH"
    exit 1
fi

# Display base branch info
echo "üîÄ Creating from branch: ${BASE_BRANCH}"

# Create worktree (creates branch if it doesn't exist)
if git show-ref --verify --quiet "refs/heads/${BASE_BRANCH}"; then
    echo "üìã Using existing branch: ${BASE_BRANCH}"
    git worktree add "$WORKTREE_PATH" "$BASE_BRANCH"
else
    echo "üÜï Creating new branch: ${WORKTREE_NAME}"
    git worktree add -b "$WORKTREE_NAME" "$WORKTREE_PATH" "$BASE_BRANCH"
fi

# Copy .claude directory if it exists
if [ -d ".claude" ]; then
    echo "üìã Copying .claude directory..."
    cp -r .claude "$WORKTREE_PATH/"
fi

if [ -d "CLAUDE.local.md" ]; then
    echo "üìã Copying .CLAUDE.local.md file..."
    cp CLAUDE.local.md "$WORKTREE_PATH/"
fi

# Change to worktree directory
cd "$WORKTREE_PATH"

# echo "üîß Setting up worktree dependencies..."
# if ! make setup; then
#     echo "‚ùå Setup failed. Cleaning up worktree..."
#     cd - > /dev/null
#     git worktree remove --force "$WORKTREE_PATH"
#     git branch -D "$WORKTREE_NAME" 2>/dev/null || true
#     echo "‚ùå Not allowed to create worktree from a branch that isn't passing setup."
#     exit 1
# fi

# Initialize thoughts (non-interactive mode with hardcoded directory)
# if [ "$INIT_THOUGHTS" = true ]; then
#     echo "üß† Initializing thoughts..."
#     cd "$WORKTREE_PATH"
#     if humanlayer thoughts init --directory humanlayer > /dev/null 2>&1; then
#         echo "‚úÖ Thoughts initialized!"
#         # Run sync to create searchable directory
#         if humanlayer thoughts sync > /dev/null 2>&1; then
#             echo "‚úÖ Thoughts searchable index created!"
#         else
#             echo "‚ö†Ô∏è  Could not create searchable index. Run 'humanlayer thoughts sync' manually."
#         fi
#     else
#         echo "‚ö†Ô∏è  Could not initialize thoughts automatically. Run 'humanlayer thoughts init' manually."
#     fi
# fi

# Return to original directory
cd - > /dev/null

echo "‚úÖ Worktree created successfully!"
echo "üìÅ Path: ${WORKTREE_PATH}"
echo "üîÄ Branch: ${BASE_BRANCH}"
echo ""
echo "To work in this worktree:"
echo "  cd ${WORKTREE_PATH}"
echo ""
echo "To remove this worktree later:"
echo "  git worktree remove ${WORKTREE_PATH}"
echo "  git branch -D ${BASE_BRANCH}"
